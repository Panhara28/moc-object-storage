// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "mysql"
}

/**
 * ============================================================
 * ENUMS
 * ============================================================
 */

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum MediaType {
  IMAGE
  VIDEO
  AUDIO
  PDF
  DOCUMENT
  OTHER
}

enum ScanStatus {
  PENDING
  CLEAN
  MALICIOUS
  FAILED
}

enum ScanJobStatus {
  PENDING
  PROCESSING
  DONE
  FAILED
}

enum Visibility {
  AVAILABLE
  PUBLIC
  PRIVATE
  RESTRICTED
  REMOVE
  RECOVERY
  DRAFTED
  PUBLISHED
  UNPUBLISHED
}

enum CategoryOf {
  DEFAULT
  BOOK
  NEWS
}

enum BucketPermission {
  READ
  READ_WRITE
  FULL_ACCESS
}

enum ApiKeyStatus {
  ACTIVE
  INACTIVE
}

/**
 * ============================================================
 * USERS
 * ============================================================
 */

model User {
  id             Int      @id @default(autoincrement())
  email          String   @unique
  name           String
  password       String
  roleId         Int?
  slug           String   @unique @default(uuid())
  profilePicture String
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  fullNameKh        String?
  fullNameEn        String?
  gender            Gender?
  generalDepartment String?
  department        String?
  office            String?
  phoneNumber       String?
  currentRole       String?

  role Role? @relation(fields: [roleId], references: [id])

  mediasUploaded Media[]       @relation("MediaUploadedBy")
  mediaUploads   MediaUpload[]
  spaces         Space[]
  buckets        Bucket[]      @relation("BucketCreatedBy")
  auditLogs      AuditLog[]
  createdApiKeys BucketApiKey[] @relation("BucketApiKeyCreatedBy")

  @@index([roleId])
  @@map("users")
}

/**
 * ============================================================
 * ROLES & PERMISSIONS
 * ============================================================
 */

model Role {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String?
  slug        String   @unique @default(uuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users       User[]
  permissions RolePermission[]

  @@map("roles")
}

model PermissionModule {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  label       String
  description String?
  slug        String   @unique @default(uuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  roles RolePermission[]

  @@map("permissions")
}

model RolePermission {
  roleId   Int
  moduleId Int

  create Boolean @default(false)
  read   Boolean @default(false)
  update Boolean @default(false)
  delete Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  slug      String   @unique @default(uuid())

  role   Role             @relation(fields: [roleId], references: [id])
  module PermissionModule @relation(fields: [moduleId], references: [id])

  @@id([roleId, moduleId])
  @@map("role_permissions")
}

/**
 * ============================================================
 * AUTH RATE LIMITING
 * ============================================================
 */

model LoginAttempt {
  id             Int      @id @default(autoincrement())
  key            String   @unique
  count          Int      @default(0)
  firstAttemptAt DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([firstAttemptAt])
  @@map("login_attempts")
}

/**
 * ============================================================
 * AUDIT LOGS
 * ============================================================
 */

model AuditLog {
  id           Int      @id @default(autoincrement())
  createdAt    DateTime @default(now())
  actorId      Int?
  action       String   @db.VarChar(64)
  resourceType String   @db.VarChar(64)
  resourceId   String?  @db.VarChar(191)
  method       String   @db.VarChar(12)
  path         String   @db.VarChar(191)
  status       Int
  ip           String?  @db.VarChar(64)
  userAgent    String?  @db.VarChar(191)
  requestId    String?  @db.VarChar(64)
  traceId      String?  @db.VarChar(64)
  metadata     Json?

  actor User? @relation(fields: [actorId], references: [id], onDelete: SetNull)

  @@index([actorId, createdAt])
  @@index([resourceType, resourceId])
  @@index([createdAt])
  @@map("audit_logs")
}

/**
 * ============================================================
 * BUCKET MODEL (TOP LEVEL STORAGE UNIT)
 * ============================================================
 */

model Bucket {
  id          Int    @id @default(autoincrement())
  name        String @unique // e.g., "panhara", "uploads"
  slug        String @unique @default(uuid())
  createdById Int
  createdBy   User   @relation("BucketCreatedBy", fields: [createdById], references: [id])

  permission  BucketPermission @default(FULL_ACCESS)
  isAvailable Visibility       @default(AVAILABLE)

  apiKeys BucketApiKey[]

  medias Media[]
  spaces Space[] // folder system inside this bucket

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("buckets")
}

model BucketApiKey {
  id               Int          @id @default(autoincrement())
  bucketId         Int
  bucket           Bucket       @relation(fields: [bucketId], references: [id])
  name             String
  accessKeyId      String       @unique
  secretAccessKey  String
  status           ApiKeyStatus @default(ACTIVE)
  createdById      Int?
  createdBy        User?        @relation("BucketApiKeyCreatedBy", fields: [createdById], references: [id])
  lastRotatedAt    DateTime?
  lastUsedAt       DateTime?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  @@unique([bucketId, name])
  @@map("bucket_api_keys")
}

/**
 * ============================================================
 * MEDIA MODEL (OBJECT STORAGE CORE)
 * ============================================================
 */

model Media {
  id   Int    @id @default(autoincrement())
  slug String @unique @default(uuid())

  filename       String
  storedFilename String
  url            String

  // ⭐ REQUIRED: Media belongs to a bucket
  bucketId Int
  bucket   Bucket @relation(fields: [bucketId], references: [id])

  // ⭐ Optional subfolder path: documents/2025/reports
  path String?

  fileType  MediaType
  mimetype  String
  extension String
  size      Int
  scanStatus  ScanStatus @default(PENDING)
  scanMessage String?
  scanHash    String?
  scannedAt   DateTime?

  title       String?
  altText     String?
  description String?

  uploadedById Int
  uploadedBy   User @relation("MediaUploadedBy", fields: [uploadedById], references: [id])

  isVisibility Visibility @default(AVAILABLE)

  isAccessible Visibility @default(PRIVATE)

  width      Int?
  height     Int?
  uploadedAt DateTime @default(now())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  spaces       Space[]
  mediaDetails MediaUploadDetail[]
  scanJobs     MediaScanJob[]

  @@map("medias")
}

/**
 * ============================================================
 * MEDIA SCAN JOBS
 * ============================================================
 */

model MediaScanJob {
  id         Int           @id @default(autoincrement())
  mediaId    Int
  filename   String
  storedPath String        @db.VarChar(1024)
  status     ScanJobStatus @default(PENDING)
  attempts   Int           @default(0)
  lastError  String?
  lockedAt   DateTime?
  runAt      DateTime      @default(now())
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  media Media @relation(fields: [mediaId], references: [id], onDelete: Cascade)

  @@index([status, runAt])
  @@index([lockedAt])
  @@map("media_scan_jobs")
}

/**
 * ============================================================
 * MEDIA UPLOAD SESSION
 * ============================================================
 */

model MediaUpload {
  id        Int      @id @default(autoincrement())
  slug      String   @unique @default(uuid())
  userId    Int
  createdAt DateTime @default(now())

  user    User                @relation(fields: [userId], references: [id])
  details MediaUploadDetail[]

  @@map("media_uploads")
}

model MediaUploadDetail {
  id            Int      @id @default(autoincrement())
  mediaUploadId Int
  mediaId       Int
  spaceId       Int?
  createdAt     DateTime @default(now())

  media       Media       @relation(fields: [mediaId], references: [id])
  mediaUpload MediaUpload @relation(fields: [mediaUploadId], references: [id])
  space       Space?      @relation(fields: [spaceId], references: [id]) // Optional space relation

  @@map("media_upload_details")
}

/**
 * ============================================================
 * SPACE MODEL (FOLDER SYSTEM INSIDE BUCKET)
 * ============================================================
 */

model Space {
  id          Int        @id @default(autoincrement())
  name        String
  slug        String     @unique @default(uuid())
  parentId    Int?
  isAvailable Visibility @default(AVAILABLE)
  uploadedAt  DateTime?

  // ⭐ Link folder to a bucket
  bucketId Int
  bucket   Bucket @relation(fields: [bucketId], references: [id])

  userId Int
  user   User @relation(fields: [userId], references: [id])

  parent   Space?  @relation("SpaceHierarchy", fields: [parentId], references: [id])
  children Space[] @relation("SpaceHierarchy")

  mediaId Int?
  media   Media? @relation(fields: [mediaId], references: [id])

  uploadDetails MediaUploadDetail[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([parentId])
  @@map("spaces")
}
