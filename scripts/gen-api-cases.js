const fs = require("fs/promises");
const path = require("path");
const { HTTP_METHODS, listApiRoutes } = require("./list-api-routes");

const TARGET_PATH = path.join(
  process.cwd(),
  "tests/api/api-cases.generated.ts"
);

function sortByMethod(a, b) {
  return HTTP_METHODS.indexOf(a) - HTTP_METHODS.indexOf(b);
}

async function main() {
  const routes = await listApiRoutes();
  const cases = routes
    .flatMap((route) =>
      route.methods.map((method) => ({
        name: `${method} ${route.route}`,
        method,
        route: route.route,
        source: path.relative(process.cwd(), route.file),
        todo: true,
      }))
    )
    .sort((a, b) => {
      if (a.route !== b.route) return a.route.localeCompare(b.route);
      return sortByMethod(a.method, b.method);
    });

  const lines = [
    "// This file is auto-generated by scripts/gen-api-cases.js.",
    "// Do not edit by hand.",
    "",
    'import type { ApiCase } from "./api-cases";',
    "",
    "export const generatedApiCases: ApiCase[] = [",
    ...cases.flatMap((entry) => [
      "  {",
      `    name: ${JSON.stringify(entry.name)},`,
      `    method: ${JSON.stringify(entry.method)},`,
      `    route: ${JSON.stringify(entry.route)},`,
      `    source: ${JSON.stringify(entry.source)},`,
      "    todo: true,",
      "  },",
    ]),
    "];",
    "",
  ];

  await fs.writeFile(TARGET_PATH, lines.join("\n"), "utf8");
  console.log(`Wrote ${TARGET_PATH}`);
}

main().catch((error) => {
  console.error(error);
  process.exitCode = 1;
});
